{% extends 'layout/manage.html' %} {% load static %} {% block css %}
<style>
  .card{
      margin-top: 20px;
  }
  .card .card-header {
          display: flex;
          flex-direction: row;
          justify-content: space-between;
      }
  .card > .card-header a {
          text-decoration: none;
      }
  .card > .card-header span {
          padding: 0 5px;
      }
  .error-msg {
          color:red;
          position: absolute;
          font-size: 12px;
      }
  a {
          text-decoration: none;
      }
  {% comment %} .card > .card-header .function .upload {
      overflow: hidden;
  }
  .card > .card-header .function .upload input {
      opacity: 0;
      position: absolute;
      top: 0;
      bottom: 0;
      width: 76px;
      left: -2px;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
  }  {% endcomment %}
</style>
{% endblock css %} {% block content %}
<div class="container-fluid">
  <div class="card">
    <div class="card-header">
      <div>
        <a href="{% url 'tracer:file' project_id=request.tracer.project.id %}">
          <i class="fas fa-home" aria-hidden="true"></i>
          <span>File Repository</span>
        </a>
        {% for record in breadcrumb_list %}
        <a
          href="{% url 'tracer:file' project_id=request.tracer.project.id %}?folder={{record.id}}"
        >
          <i class="fas fa-caret-right" aria-hidden="true"></i>
          <span>{{ record.name }}</span>
        </a>
        {% endfor %}
      </div>

      <div class="function">
        <label class="btn btn-primary btn-sm" for="uploadFile">
          <input
            class="d-none"
            type="file"
            name="uploadFile"
            id="uploadFile"
            multiple
          />
          <i class="fas fa-upload" aria-hidden="true"></i> Upload File
        </label>
        <a
          type="button"
          class="btn btn-success btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#addModal"
          data-whatever="New Folder"
        >
          <i class="fas fa-plus-circle" aria-hidden="true"></i>
          New Folder
        </a>
      </div>
    </div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Size</th>
            <th scope="col">Update User</th>
            <th scope="col">Update Time</th>
            <th scope="col">Operation</th>
          </tr>
        </thead>
        <tbody>
          {% for item in file_object_list %}
          <tr>
            <th>
              {% if item.file_type == 1 %}
              <i class="fas fa-file"></i>
              {{ item.name }} {% else %}
              <a
                href="{% url 'tracer:file' project_id=request.tracer.project.id %}?folder={{ item.id }}"
              >
                <i class="fas fa-folder"></i>
                {{ item.name }}
              </a>
              {% endif %}
            </th>
            <td>
              {% if item.file_type == 1 %} {{ item.file_size }} {% else %} - {% endif %}
            </td>
            <td>{{ item.update_user.username }}</td>
            <td>{{ item.update_datetime }}</td>
            <td>
              {% if item.file_type == 2 %}
              <a
                class="btn btn-outline-primary btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#addModal"
                data-whatever="Edit Folder"
                data-name="{{ item.name }}"
                data-fid="{{ item.id }}"
              >
                <i class="far fa-edit" aria-hidden="true"></i>
              </a>

              {% endif %}
              <a
                class="btn btn-danger btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#alertModal"
                data-fid="{{ item.id }}"
              >
                <i class="far fa-trash-alt" aria-hidden="true"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!--Modal-->
  <div class="modal" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modal title</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            {% csrf_token %}
            <input type="hidden" name="fid" id="fid" />
            {% for field in form %}
            <div class="mb-3">
              <label for="{{field.id_for_label }}" class="form-label fw-bold"
                >{{ field.label }}</label
              >
              {{ field }}
              <span class="error-msg">{{ field.errors.0 }}</span>
            </div>
            {% endfor %}
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button id="btnFormSubmit" type="button" class="btn btn-primary">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!--Delete Modal-->
  <div class="modal" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
          style="margin-bottom: auto"
        >
          <strong>Are you sure to delete?</strong>
          <p style="padding-top: 20px; padding-bottom: 20px">
            All the files and folders under this folder will be deleted.
          </p>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
          <div style="text-align: right">
            <a
              class="btn btn-primary btn-sm"
              data-bs-dismiss="modal"
              aria-label="Close"
              >Cancel</a
            >
            <button id="btnDelete" type="button" class="btn btn-danger btn-sm">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endblock content %} {% block js %}
  <script src="{% static 'js/cos-js-sdk-v5.min.js' %}"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

  <script>
    var FOLDER_URL =
      "{% url 'tracer:file' project_id=request.tracer.project.id %}";
    var FILE_DELETE_URL =
      "{% url 'tracer:file_delete' project_id=request.tracer.project.id %}";
    var COS_CREDENTIALS =
      "{% url 'tracer:cos_credentials' project_id=request.tracer.project.id %}";

    $(function () {
      initAddModal();
      bindModalSubmit();
      bindDeleteSubmit();
      bindUploadFile();
    });

    function bindUploadFile() {
      // 通过临时凭证上传文件到tencent cos
      $("#uploadFile").change(function () {

        var fileList = $(this)[0].files; // $(this)[0] is the dom object

        // 获取本次要上传的每个文件的名字和大小
        var checkFileList = [];
        
        $.each(fileList, function (index, fileObject) {
          
          checkFileList.push({
                name: fileObject.name,
                size: fileObject.size,
        });
        
        // 把这些数据发送到时django后台，进行校验,校验通过后返回临时凭证再上传，否则提示错误信息 
        var cos = new COS({
          // getAuthorization 必选参数
          getAuthorization: function (options, callback) {
            // 异步获取临时密钥
            // 服务端 JS 和 PHP 例子：https://github.com/tencentyun/cos-js-sdk-v5/blob/master/server/
            // 服务端其他语言参考 COS STS SDK ：https://github.com/tencentyun/qcloud-cos-sts-sdk
            // STS 详细文档指引看：https://cloud.tencent.com/document/product/436/14048

            var url = COS_CREDENTIALS; // url替换成您自己的后端服务
            var xhr = new XMLHttpRequest();
            var dataList = JSON.stringify(checkFileList);
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onload = function (e) {
                
                var res = JSON.parse(e.target.responseText);
                console.log(res);
                if (res.status){
                    var credentials = res.data.credentials;

                    callback({
                        TmpSecretId: credentials.tmpSecretId,
                        TmpSecretKey: credentials.tmpSecretKey,
                        SecurityToken: credentials.sessionToken,
                        // 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误
                        StartTime: res.data.startTime, // 时间戳，单位秒，如：1580000000
                        ExpiredTime: res.data.expiredTime, // 时间戳，单位秒，如：1580000000
                    });
                }
                else{
                    // alert(data.error);
                    swal({
                        title: "Error",
                        text: res.error,
                        icon: "error",
                        button: "OK",
                    });
                  }

            };
            xhr.send(dataList);
          },
        }); // 接下来可以通过 cos 实例调用 COS 请求。

        $.each(fileList, function(index, fileObject){
            var fileName = fileObject.name;
            var fileSize = fileObject.size;
        
            cos.putObject(
            {
              Bucket: "{{ request.tracer.project.bucket }}",
              Region: "{{ request.tracer.project.region }}",
              Key: fileName,
              StorageClass: "STANDARD",
              Body: fileObject,
              onProgress: function (progressData) {
                console.log(JSON.stringify(progressData));
              },
            },
            function (err, data) {
              console.log(err || data);
            }
          );
          }) 
        });
      });
    }

    function initAddModal() {
      $("#addModal").on("show.bs.modal", function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        var title = button.data("whatever");
        var name = button.data("name");
        var fid = button.data("fid");
        modal.find(".modal-title").text(title);

        if (fid) {
          // 编辑文件夹
          modal.find("#id_name").val(name);
          modal.find("#fid").val(fid);
        } else {
          // 新建文件夹
          modal.find(".error-msg").empty();
          $("#addForm")[0].reset();
        }
      });

      // 为模态框绑定关闭事件
      $("#alertModal").on("show.bs.modal", function (event) {
        var button = $(event.relatedTarget);
        var fid = button.data("fid");
        $("#btnDelete").attr("fid", fid);
      });
    }

    function bindModalSubmit() {
      $("#btnFormSubmit").click(function () {
        $.ajax({
          url: location.href,
          type: "POST",
          data: $("#addForm").serialize(),
          dataType: "JSON",
          success: function (res) {
            if (res.status) {
              location.href = location.href;
            } else {
              $.each(res.errors, function (key, value) {
                $("#id_" + key)
                  .next()
                  .text(value[0]);
              });
            }
          },
        });
      });
    }

    function bindDeleteSubmit() {
      $("#btnDelete").click(function () {
        // 获取要删除文件id
        $.ajax({
          url: FILE_DELETE_URL,
          type: "GET",
          data: {
            fid: $(this).attr("fid"),
          },
          dataType: "JSON",
          success: function (res) {
            if (res.status) {
              location.href = location.href;
            } else {
              alert(res.msg);
            }
          },
        });
      });
    }
  </script>
  {% endblock js %}
</div>
