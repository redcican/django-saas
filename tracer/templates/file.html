{% extends 'layout/manage.html' %}
{% block css %}
<style>
    .card{
        margin-top: 20px;
    }
    .card .card-header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }
    .card > .card-header a {
            text-decoration: none;
        }
    .card > .card-header span {
            padding: 0 5px;
        }
    .error-msg {
            color:red;
            position: absolute;
            font-size: 12px;
        }
    a {
            text-decoration: none;
        }
    </style>
{% endblock css %}

{% block content %}
    <div class="container-fluid">
    <div class="card">
        <div class="card-header">
             <div>
                <a href="{% url 'tracer:file' project_id=request.tracer.project.id %}">
                    <i class="fas fa-home" aria-hidden="true"></i>
                    <span>File Repository</span>
                </a>
                {% for record in breadcrumb_list %}
                    <a href="{% url 'tracer:file' project_id=request.tracer.project.id %}?folder={{record.id}}">
                    <i class="fas fa-caret-right" aria-hidden="true"></i>
                    <span>{{ record.name }}</span>
                </a>
                {% endfor %}
            </div>
            
            <div>
                <a type="button" class="btn btn-success btn-sm" 
                    data-bs-toggle="modal"
                    data-bs-target="#addModal"
                    data-whatever="New Folder"
                    >
                    <i class="fas fa-plus-circle" aria-hidden="true"></i>
                    New Folder
                </a>
            </div>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Size</th>
                    <th scope="col">Update User</th>
                    <th scope="col">Update Time</th>
                    <th scope="col">Operation</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in file_object_list %}
                        <tr>
                            <th>
                                {% if item.file_type == 1 %}
                                    <i class="fas fa-file"></i> 
                                    {{ item.name }}                              
                                {% else %}
                                <a
                                href="{% url 'tracer:file' project_id=request.tracer.project.id %}?folder={{ item.id }}">
                                    <i class="fas fa-folder"></i>
                                     {{ item.name }}
                                </a>
                                {% endif %}
                            </th>
                            <td>
                                {% if item.file_type == 1 %}
                                    {{ item.file_size }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ item.update_user.username }}</td>
                            <td>{{ item.update_datetime }}</td>
                            <td>
                                {% if item.file_type == 2 %}
                                    <a  class="btn btn-outline-warning btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#addModal"
                                        data-whatever="Edit Folder"
                                        data-name={{ item.name }}
                                        data-fid={{ item.id }}>
                                        <i class="far fa-edit" aria-hidden="true"></i>
                                    </a>
                                    
                                {% endif %}
                                <a href="#">Delete</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!--Modal-->
<div class="modal" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addForm">
          {% csrf_token %} 
          <input type="hidden" name="fid" id="fid">
          {% for field in form %}
          <div class="mb-3">
            <label for="{{field.id_for_label }}" class="form-label fw-bold"
              >{{ field.label }}</label>
            {{ field }}
            <span class="error-msg">{{ field.errors.0 }}</span>
          </div>
          {% endfor %}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="btnFormSubmit" type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block js %}
<script>

    var FOLDER_URL = "{% url 'tracer:file' project_id=request.tracer.project.id %}";

    $(function() {
        initAddModal();
        bindModalSubmit();
    });

    function initAddModal() {
        $('#addModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var modal = $(this);
            var title = button.data('whatever');
            var name = button.data('name');
            var fid = button.data('fid');
            modal.find('.modal-title').text(title);

            if(fid){
            // 编辑文件夹
                modal.find('#id_name').val(name);
                modal.find('#fid').val(fid);
            }
            else{
                // 新建文件夹
                modal.find('.error-msg').empty();
                $('#addForm')[0].reset();
            }


        });
    }

    function bindModalSubmit() {
        $('#btnFormSubmit').click(function() {
            $.ajax({
                url: location.href,
                type: "POST",
                data: $('#addForm').serialize(),
                dataType: "JSON",
                success: function(res){
                    if (res.status) {
                        location.href = location.href;
                    } else {
                        $.each(res.errors, function (key, value) {
                        $("#id_" + key)
                            .next()
                            .text(value[0]);
                        });
                    }
                }
            })
        });
    }

</script>
{% endblock js %}